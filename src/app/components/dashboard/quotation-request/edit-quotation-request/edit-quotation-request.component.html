<form [formGroup]="form">
    <mat-toolbar class="title">
        <button mat-icon-button class="textColor" type="button" (click)="cancel()">
            <mat-icon>arrow_back_ios</mat-icon>
        </button>
        <span>EDITAR COTIZACIÓN</span>
        <div class="item-spacer"></div>
        <button type="button" (click)="update()" class="btnPrimary" [disabled]="form.invalid || loading"
            style="height:80%; margin-top: 10px;" mat-raised-button>
            <mat-icon class="icon-size">save</mat-icon>GUARDAR
        </button>
    </mat-toolbar> <br>

    <div class="secondary">
        <mat-spinner diameter="50" *ngIf="loading" class="spinner" color="primary"></mat-spinner>

    </div>
    <div class="container">
        <mat-card class="card colorSecondary" *ngIf="!loading && !error">
            <mat-card class="mat-elevation-z8 card-prop" style="padding:0%; margin-bottom: 20px;">
                <mat-card-header class="primary" style="padding:10px">
                    <mat-icon style="font-size:20px">request_quote</mat-icon>
                    <span>
                        EDITAR COTIZACIÓN
                    </span>
                </mat-card-header>

                <mat-grid-list cols="12" rowHeight="80px">


                    <mat-grid-tile [colspan]="colMedium" [rowspan]="1">
                        <mat-form-field appearance="outline" floatLabel="always">
                            <mat-label>CLIENTE</mat-label>
                            <input [readonly]="true" matInput formControlName="client">
                            <mat-error *ngIf="form.invalid">Este campo es obligatorio</mat-error>
                        </mat-form-field>
                    </mat-grid-tile>
                    <mat-grid-tile [colspan]="colSmall" [rowspan]="1">
                        <button type="button" (click)="openCatalogClients()" class="btnPrimary" style="margin: 5px;"
                            mat-raised-button>
                            <mat-icon class="icon-size">library_books</mat-icon>ELEGIR CLIENTE
                        </button>
                        <div class="item-spacer"></div>
                    </mat-grid-tile>
                    <mat-grid-tile [colspan]="colBig" [rowspan]="1">
                        <mat-form-field appearance="outline" floatLabel="always">
                            <mat-label>LISTA DE PRECIO </mat-label>
                            <mat-select class="mat-select-disabled" [disabled]="true" [formControl]="typePriceCtrl"
                                (selectionChange)="setTypePrice()" #singleSelect required>
                                <mat-option>
                                    <ngx-mat-select-search placeholderLabel="Buscar..."
                                        [formControl]="typePriceFilterCtrl">
                                    </ngx-mat-select-search>
                                </mat-option>
                                <mat-option *ngFor="let type_price of filteredTypePrice | async" [value]="type_price">
                                    {{type_price.label!}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </mat-grid-tile>

                    <mat-grid-tile [colspan]="colBig" [rowspan]="1">
                        <mat-form-field appearance="outline" floatLabel="always">
                            <mat-label>COMENTARIOS</mat-label>
                            <textarea matInput formControlName="comments" rows="1"></textarea>
                            <mat-error *ngIf="form.invalid">Este campo es obligatorio</mat-error>
                        </mat-form-field>
                    </mat-grid-tile>

                    <mat-grid-tile [colspan]="colBig" [rowspan]="1">
                        <mat-form-field appearance="outline" floatLabel="always">
                            <mat-label>TOTAL A INVERTIR</mat-label>
                            <span matPrefix>$ &nbsp;</span>
                            <input matInput formControlName="total_invest" type="number" style="text-align:right;">
                            <mat-error *ngIf="form.invalid">Ingresa solo números</mat-error>
                        </mat-form-field>
                    </mat-grid-tile>
                    <mat-grid-tile [colspan]="12" [rowspan]="1">
                        <div class="item-spacer"></div>
                        <button type="button" class="btnPrimary" (click)="openCatalogProducts()" [disabled]="loading"
                            style="height:80%; margin-top: 10px;" mat-raised-button>
                            <mat-icon class="icon-size">library_books</mat-icon>SELECCIONAR PRODUCTO
                        </button>
                        <button type="button" [disabled]="loading"
                            style="height:80%; margin: 5px;background-color: var(--yellow);" mat-raised-button
                            (click)="addNewProduct()">
                            <mat-icon class="icon-size">add</mat-icon>AGREGAR NUEVO PRODUCTO
                        </button>
                    </mat-grid-tile>

                </mat-grid-list>
                <div class="table-container-medium" style="width:99%; margin: 0 auto; ">
                    <div class="overlay-loading" *ngIf="loading">
                        <div class="spinner-wrapper">
                            <mat-spinner diameter="50" *ngIf="loading" class="spinner" color="primary"></mat-spinner>
                        </div>
                    </div>
                    <table mat-table [dataSource]="dataProducts" matSort>
                        <tr mat-header-row *matHeaderRowDef="displayedColumnsProductsOrders; sticky: true"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumnsProductsOrders;"></tr>
                        <ng-container matColumnDef="amount">
                            <th mat-header-cell class="primary" *matHeaderCellDef mat-sort-header="amount">
                                CANTIDAD</th>
                            <td mat-cell *matCellDef="let item; let i = index;" style="width:10%"
                                [ngClass]="{'newProduct': item.id_product == 0}">
                                <input class="custom-input" [ngModelOptions]="{standalone: true}" type="number"
                                    [(ngModel)]="item.amount" (change)="validateAmount(i)">
                            </td>
                        </ng-container>
                        <ng-container matColumnDef="amount_pieces">
                            <th mat-header-cell class="primary" *matHeaderCellDef mat-sort-header="amount_pieces">
                                PIEZAS</th>
                            <td mat-cell *matCellDef="let item; let i = index;" style="width:10%"
                                [ngClass]="{'newProduct': item.id_product == 0}">
                                <span *ngIf="item.id_product != 0">
                                    {{item.amount_pieces}}
                                </span>
                                <input *ngIf="item.id_product == 0" class="custom-input"
                                    [ngModelOptions]="{standalone: true}" type="number" [(ngModel)]="item.amount_pieces"
                                    (change)="validateAmount(i)">
                            </td>
                        </ng-container>
                        <ng-container matColumnDef="code">
                            <th mat-header-cell class="primary" *matHeaderCellDef mat-sort-header="code">
                                CODIGO</th>
                            <td mat-cell *matCellDef="let item" style="width:10%"
                                [ngClass]="{'newProduct': item.id_product == 0}">
                                <span *ngIf="item.id_product != 0">
                                    {{item.code}}
                                </span>
                                <input *ngIf="item.id_product == 0" class="custom-input-text"
                                    [ngModelOptions]="{standalone: true}" [(ngModel)]="item.code">
                            </td>
                        </ng-container>
                        <ng-container matColumnDef="description">
                            <th mat-header-cell class="primary" *matHeaderCellDef mat-sort-header="description">
                                DESCRIPCIÓN</th>
                            <td mat-cell *matCellDef="let item" style="width:15%"
                                [ngClass]="{'newProduct': item.id_product == 0}">

                                <span *ngIf="item.id_product != 0">
                                    {{item.description}}
                                </span>
                                <input *ngIf="item.id_product == 0" class="custom-input-text"
                                    [ngModelOptions]="{standalone: true}" [(ngModel)]="item.description">
                            </td>
                        </ng-container>
                        <ng-container matColumnDef="price">
                            <th mat-header-cell class="primary" *matHeaderCellDef mat-sort-header="price">
                                PRECIO</th>
                            <td mat-cell *matCellDef="let item; let i = index;" style="width:10%;text-align: right;"
                                [ngClass]="{'newProduct': item.id_product == 0}">
                                <div *ngIf="item.id_product != 0" style="padding-right: 20%"> {{
                                    item.price | currency: '2' :
                                    "$"}} </div>
                                <span *ngIf="item.id_product == 0" class="input-symbol">
                                    <input class="custom-input" [ngModelOptions]="{standalone: true}" type="number"
                                        [(ngModel)]="item.price" (change)="validatePrice(i)">
                                </span>

                            </td>
                        </ng-container>

                        <ng-container matColumnDef="price_unit">
                            <th mat-header-cell class="primary" *matHeaderCellDef mat-sort-header="price_unit">
                                PRECIO X UNIDAD</th>
                            <td mat-cell *matCellDef="let item" style="width:10%;text-align: right;"
                                [ngClass]="{'newProduct': item.id_product == 0}">
                                <div style="padding-right: 20%"> {{
                                    '$ ' + (item.price_unit | number: '1.4-4') }} </div>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="total">
                            <th mat-header-cell class="primary" *matHeaderCellDef mat-sort-header="total">
                                TOTAL</th>
                            <td mat-cell *matCellDef="let item" style="width:10%;text-align: right;"
                                [ngClass]="{'newProduct': item.id_product == 0}">
                                <div style="padding-right: 20%"> {{
                                    item.total | currency: '2' :
                                    "$"}} </div>
                            </td>
                        </ng-container>
                        <ng-container matColumnDef="actions">
                            <th class="primary" mat-header-cell *matHeaderCellDef></th>
                            <td mat-cell *matCellDef="let item; let i = index" (click)="deleteProductByIndex(i)"
                                style="width:5%; text-align: right;" [ngClass]="{'newProduct': item.id_product == 0}">
                                <a class="btnAction" style="color:rgb(193, 32, 32)" matTooltip="ELIMINAR">
                                    <mat-icon class="custom-size-animation">delete</mat-icon>
                                </a>
                            </td>
                        </ng-container>
                    </table>
                </div><br>
            </mat-card>

        </mat-card>
        <mat-card *ngIf="error" class="colorSecondary">
            <div class="error">
                <mat-icon style="font-size: 50px" aria-hidden="false">lock</mat-icon>
                <h1>{{error_msg}}</h1>
            </div>
        </mat-card>


    </div>
</form>