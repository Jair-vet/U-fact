<form [formGroup]="form" (ngSubmit)="create()">
    <mat-toolbar class="title">
        <button mat-icon-button class="textColor" type="button" (click)="cancel()">
            <mat-icon>arrow_back_ios</mat-icon>
        </button>
        <span>AGREGAR REQUISICIÓN</span>
        <div class="item-spacer"></div>

        <button type="submit" class="btnPrimary" [disabled]="loading" style="height:80%; margin-top: 10px;"
            mat-raised-button>
            <mat-icon class="icon-size">save</mat-icon>GUARDAR
        </button>
    </mat-toolbar> <br>

    <div class="secondary">
        <mat-spinner diameter="50" *ngIf="loading" class="spinner" color="primary"></mat-spinner>

    </div>
    <div class="container">
        <mat-card class="colorSecondary card" *ngIf="!loading && !error">
            <mat-card class="mat-elevation-z8 card-prop" style="padding:0%; margin-bottom: 20px;">
                <mat-card-header class="primary" style="padding:10px">
                    <mat-icon style="font-size:20px">inventory</mat-icon>
                    <span>
                        SELECCIONAR PRODUCTOS
                    </span>
                </mat-card-header>

                <mat-grid-list cols="12" rowHeight="80px">
                    <mat-grid-tile [colspan]="colMedium" [rowspan]="1">
                        <mat-form-field appearance="outline" floatLabel="always">
                            <mat-label>USUARIO QUE SOLICITA</mat-label>
                            <input [readonly]="true" matInput formControlName="productor">
                            <mat-error *ngIf="form.invalid">Este campo es obligatorio</mat-error>
                        </mat-form-field>
                    </mat-grid-tile>


                    <mat-grid-tile [colspan]="colMedium" [rowspan]="1">
                        <mat-form-field appearance="outline" floatLabel="always">
                            <mat-label>¿A DONDE ENVÍA?</mat-label>
                            <mat-select [formControl]="storeCtrl" (selectionChange)="setStore()" #singleSelect required>
                                <mat-option>
                                    <ngx-mat-select-search placeholderLabel="Buscar..." [formControl]="storeFilterCtrl">
                                    </ngx-mat-select-search>
                                </mat-option>
                                <mat-option *ngFor="let store of filteredStore | async" [value]="store">
                                    {{store.name!}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </mat-grid-tile>
                    <mat-grid-tile [colspan]="colMedium" [rowspan]="1">
                        <div class="item-spacer"></div>
                        <button type="button" (click)="openCatalogProducts()" class="btnPrimary"
                            style="margin-right: 5px;" mat-raised-button>
                            <mat-icon class="icon-size">add</mat-icon>AGREGAR PRODUCTOS
                        </button>

                    </mat-grid-tile>

                    <mat-grid-tile [colspan]="colBig" [rowspan]="1">
                        <mat-form-field appearance="outline" floatLabel="always">
                            <mat-label>COMENTARIOS</mat-label>
                            <textarea matInput formControlName="comments_global" placeholder="Información..."
                                rows="1"></textarea>
                        </mat-form-field>
                    </mat-grid-tile>

                    <mat-grid-tile [colspan]="12" [rowspan]="4" style="top:0px;">
                        <div class="table-container-medium">
                            <div class="overlay-loading" *ngIf="loading">
                                <div class="spinner-wrapper">

                                    <mat-spinner diameter="50" *ngIf="loading" class="spinner"
                                        color="primary"></mat-spinner>
                                </div>
                            </div>
                            <table mat-table [dataSource]="dataProductsRequisitions" matSort>

                                <tr mat-header-row
                                    *matHeaderRowDef="displayedColumnsProductsRequisitions; sticky: true">
                                </tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumnsProductsRequisitions;">
                                </tr>

                                <ng-container matColumnDef="amount">
                                    <th mat-header-cell class="primary" *matHeaderCellDef mat-sort-header="amount">
                                        CANTIDAD</th>
                                    <td mat-cell *matCellDef="let item; let i = index;" style="width:15%">
                                        <input class="custom-input" [ngModelOptions]="{standalone: true}" type="number"
                                            [(ngModel)]="item.amount" (change)="updateProductsRequisitions(i)">
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="code">
                                    <th mat-header-cell class="primary" *matHeaderCellDef mat-sort-header="code">
                                        CODIGO</th>
                                    <td mat-cell *matCellDef="let item" style="width:15%">
                                        {{item.code}}</td>
                                </ng-container>
                                <ng-container matColumnDef="description">
                                    <th mat-header-cell class="primary" *matHeaderCellDef mat-sort-header="description">
                                        DESCRIPCIÓN</th>
                                    <td mat-cell *matCellDef="let item" style="width:20%">
                                        {{item.description}}</td>
                                </ng-container>

                                <ng-container matColumnDef="inventory">
                                    <th mat-header-cell class="primary" *matHeaderCellDef mat-sort-header="inventory">
                                        EXISTENCIA</th>
                                    <td mat-cell *matCellDef="let item" style="width:15%">
                                        {{item.inventory - item.requested_inventory}}</td>
                                </ng-container>

                                <ng-container matColumnDef="comments">
                                    <th mat-header-cell class="primary" *matHeaderCellDef mat-sort-header="comments">
                                        COMENTARIOS</th>
                                    <td mat-cell *matCellDef="let item" style="width:35%">
                                        <input class="custom-input-comments" [ngModelOptions]="{standalone: true}"
                                            type="text" [(ngModel)]="item.comments">
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="actions">
                                    <th class="primary" mat-header-cell *matHeaderCellDef>
                                        ACCIONES </th>
                                    <td mat-cell *matCellDef="let item; let i = index"
                                        style="width:10%; text-align: right;">
                                        <a class="btnAction" (click)="deleteProductRequisition(i)"
                                            style="color:rgb(193, 32, 32)" matTooltip="ELIMINAR">
                                            <mat-icon class="custom-size-animation">delete</mat-icon>
                                        </a>
                                        <a class="btnAction" style="color:var(--secondary)"
                                            [matTooltip]="item.comments">
                                            <mat-icon class="custom-size-animation">message</mat-icon>
                                        </a>
                                    </td>
                                </ng-container>
                            </table>
                        </div>
                    </mat-grid-tile>
                </mat-grid-list>


            </mat-card>
        </mat-card>
        <mat-card *ngIf="error" class="colorSecondary">
            <div class="error">
                <mat-icon style="font-size: 50px" aria-hidden="false">lock</mat-icon>
                <h1>{{error_msg}}</h1>
            </div>
        </mat-card>

    </div>
</form>